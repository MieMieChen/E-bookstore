# 医疗流程挖掘工具

将医疗流程数据转换为 XES 格式，用于 ProM 流程挖掘分析。

## 🎯 核心问题解决

### 您遇到的问题

根据您的 Petri 网图，存在以下问题：
1. **流程过于发散** - 多个活动直接连到结束节点
2. **缺少顺序关系** - 正常医疗流程应该有清晰的先后顺序
3. **Case ID 可能错误** - 导致流程挖掘结果不正确

### 根本原因

**最可能的原因是 Case ID 使用错误：**

```
❌ 错误示例：使用用户ID作为Case ID
用户2400 → 挂号(事件1) → 检查(事件2) → ...
用户2400 → 挂号(事件3) → 检查(事件4) → ...  # 这是另一次就诊！

结果：ProM会把同一用户的所有就诊混在一起
```

```
✅ 正确示例：使用挂号ID作为Case ID
挂号001 → 挂号 → 检查 → 报告审核 → 诊断 → 开方 → 配药 → 发药 → 收费
挂号002 → 挂号 → 检查 → 报告审核 → 诊断 → 开方 → 配药 → 发药 → 收费

结果：每次就诊是一个完整的案例，流程清晰
```

## 📋 数据要求

### 必需字段

| 字段名 | 说明 | 示例 |
|--------|------|------|
| 挂号ID | **每次就诊的唯一标识**（不是用户ID！） | "REG20230514001" |
| 活动名称 | 流程步骤名称 | "挂号", "检查", "报告审核" |
| 开始时间 | 活动开始时间 | "2023-05-14 14:14:07" |

### 可选字段

| 字段名 | 说明 | 示例 |
|--------|------|------|
| 结束时间 | 活动结束时间 | "2023-05-14 14:18:03" |
| 持续时间 | 活动持续秒数 | 236 |
| 角色 | 执行者角色 | "检查检验科医生" |
| 人员ID | 执行者标识 | "检查检验科医生_P22" |
| 用户ID | 患者ID（可选，用于分析） | "2400" |

### 数据格式示例

**Excel/CSV 格式：**

| 挂号ID | 活动名称 | 开始时间 | 结束时间 | 角色 | 人员ID |
|--------|----------|----------|----------|------|--------|
| REG001 | 挂号 | 2023-05-14 10:00:00 | 2023-05-14 10:05:00 | 挂号员 | 挂号员_P01 |
| REG001 | 检查 | 2023-05-14 10:30:00 | 2023-05-14 10:50:00 | 检查科医生 | 检查科医生_P10 |
| REG001 | 报告审核 | 2023-05-14 14:14:07 | 2023-05-14 14:18:03 | 检查检验科医生 | 检查检验科医生_P22 |
| REG002 | 挂号 | 2023-05-14 11:00:00 | 2023-05-14 11:05:00 | 挂号员 | 挂号员_P02 |
| REG002 | 检查 | 2023-05-14 11:30:00 | 2023-05-14 11:50:00 | 检查科医生 | 检查科医生_P11 |

**关键点：**
- ✅ REG001 的所有事件共享同一个挂号ID
- ✅ REG002 是另一次就诊，有自己的挂号ID
- ✅ 每个挂号ID包含多个活动，形成完整流程

## 🚀 使用步骤

### 步骤 1: 诊断数据

首先运行诊断工具，检查数据是否正确：

```bash
python diagnose_data.py your_data.xlsx
```

**诊断工具会检查：**
- ✓ Case ID 是否正确（每个案例应该有多个事件）
- ✓ 活动名称分布
- ✓ 时间格式
- ✓ 流程变体
- ✓ 数据完整性

**如果看到以下警告，说明 Case ID 错误：**
```
✗ 警告: 每行都是不同的挂号ID！
   这意味着没有案例包含多个事件
   请检查是否使用了错误的列作为挂号ID
```

### 步骤 2: 转换为 XES

数据检查无误后，转换为 XES 格式：

```bash
python convert_to_xes.py
```

**脚本会自动：**
1. 清洗数据（删除缺失值、重复值）
2. 按挂号ID和时间排序
3. 转换为标准 XES 格式
4. 生成 `medical_process.xes` 文件

### 步骤 3: 在 ProM 中分析

1. 打开 ProM
2. **Import** → 选择 `medical_process.xes`
3. 选择流程挖掘算法：
   - **Inductive Miner** (推荐) - 处理噪声数据能力强
   - **Alpha Miner** - 适合简单流程
   - **Heuristic Miner** - 适合复杂流程
4. 可视化 Petri 网

## 🔧 数据清洗建议

### 常见问题及解决方案

#### 问题 1: Case ID 错误

**症状：** ProM 生成的 Petri 网过于发散，没有清晰流程

**原因：** 使用了用户ID而不是挂号ID

**解决：**
```python
# 如果您的数据中挂号ID列名不同，修改脚本中的列名映射
# 例如，如果挂号ID列名为 "就诊ID"：
df = df.rename(columns={'就诊ID': '挂号ID'})
```

#### 问题 2: 活动名称不统一

**症状：** 同一活动有多个名称

**解决：**
```python
# 标准化活动名称
activity_mapping = {
    '挂号': ['挂号', '门诊挂号', '预约挂号'],
    '检查': ['检查', '体检', '检验'],
    '报告审核': ['报告审核', '审核报告', '报告复核']
}

for standard, variants in activity_mapping.items():
    df.loc[df['活动名称'].isin(variants), '活动名称'] = standard
```

#### 问题 3: 时间格式不统一

**症状：** 转换失败或时间解析错误

**解决：**
```python
# 脚本会自动尝试多种时间格式
# 如果仍然失败，手动指定格式：
df['开始时间'] = pd.to_datetime(df['开始时间'], format='%Y-%m-%d %H:%M:%S')
```

#### 问题 4: 不完整的案例

**症状：** 某些案例只有1-2个事件

**解决：**
```python
# 脚本会自动过滤事件数少于2的案例
# 可以调整阈值：
min_events = 3  # 只保留至少3个事件的案例
```

## 📊 预期结果

### 正确的 Petri 网应该是这样的：

```
[开始] → 挂号 → 检查 → 报告审核 → 诊断 → 开方 → 配药 → 发药 → 收费 → [结束]
           ↓                                      ↓
         开单                                   收费
```

**特征：**
- ✓ 有清晰的主流程路径
- ✓ 活动之间有明确的因果关系
- ✓ 可能有分支（如：检查后可能直接开方，或需要进一步诊断）
- ✓ 大部分案例遵循相似的路径

### 错误的 Petri 网是这样的：

```
[开始] → 挂号 ↘
      → 检查 → [结束]
      → 开方 ↗
      → 配药 ↗
      → 发药 ↗
```

**问题：**
- ✗ 所有活动都直接连到开始/结束
- ✗ 没有活动之间的顺序关系
- ✗ 说明 Case ID 错误

## 🐛 故障排除

### 问题：转换后 ProM 无法打开文件

**解决：**
1. 检查 XES 文件是否为空
2. 用文本编辑器打开 XES 文件，检查格式是否正确
3. 确保 ProM 版本支持 XES 1.0 格式

### 问题：Petri 网仍然不正确

**可能原因：**
1. **Case ID 仍然错误** - 重新检查挂号ID列
2. **数据不完整** - 某些活动缺失
3. **时间顺序错误** - 事件时间戳不准确
4. **活动名称混乱** - 需要标准化

**调试步骤：**
```bash
# 1. 重新诊断数据
python diagnose_data.py your_data.xlsx

# 2. 检查输出的统计信息
# 特别注意：
# - 每个案例的平均事件数（应该 > 3）
# - 流程变体数量（不应该等于案例总数）
# - 活动分布（应该比较均匀）

# 3. 查看数据样例
# 确认同一挂号ID的事件确实属于同一次就诊
```

## 📝 自定义配置

### 修改列名映射

编辑 `convert_to_xes.py` 中的 `column_mapping` 字典：

```python
column_mapping = {
    '挂号ID': ['挂号ID', '就诊ID', '案例ID', 'registration_id'],
    '活动名称': ['活动名称', '事件名称', 'activity'],
    # ... 添加您的列名变体
}
```

### 调整数据清洗规则

修改 `clean_medical_data()` 函数中的参数：

```python
# 最小事件数阈值
min_events = 2  # 改为 3 或更高

# 删除重复事件
df_cleaned = df_cleaned.drop_duplicates(subset=['挂号ID', '活动名称', '开始时间'])
```

## 📚 参考资料

- [XES 标准文档](http://www.xes-standard.org/)
- [ProM 用户指南](http://www.promtools.org/)
- [流程挖掘入门](https://www.coursera.org/learn/process-mining)

## 🤝 支持

如果遇到问题：
1. 先运行 `diagnose_data.py` 检查数据
2. 查看本文档的"故障排除"部分
3. 检查数据样例是否符合要求

## 📄 许可证

MIT License




