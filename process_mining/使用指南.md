# 医疗流程挖掘 - 完整使用指南

## 🎯 您的问题

根据您提供的 Petri 网图，流程挖掘结果不正确，主要表现为：

1. **流程过于发散** - 所有活动都直接连到结束节点
2. **缺少顺序关系** - 看不出活动之间的因果关系
3. **不符合实际流程** - 医疗流程应该是：挂号→检查→报告审核→诊断→开方→配药→发药→收费

## 🔍 根本原因

**99% 的可能性是 Case ID (挂号ID) 使用错误！**

### 错误示例

```
错误的数据结构：
用户ID | 活动名称 | 时间
2400   | 挂号    | 10:00
2400   | 检查    | 10:30
2400   | 挂号    | 次日10:00  ← 这是另一次就诊！
2400   | 检查    | 次日10:30

如果用"用户ID"作为Case ID，ProM会认为：
- 案例2400包含：挂号→检查→挂号→检查
- 这显然是错误的！
```

### 正确示例

```
正确的数据结构：
挂号ID  | 用户ID | 活动名称 | 时间
REG001 | 2400  | 挂号    | 10:00
REG001 | 2400  | 检查    | 10:30
REG001 | 2400  | 报告审核 | 14:14
REG002 | 2400  | 挂号    | 次日10:00  ← 新的就诊
REG002 | 2400  | 检查    | 次日10:30

用"挂号ID"作为Case ID：
- 案例REG001：挂号→检查→报告审核 ✓
- 案例REG002：挂号→检查 ✓
- 每次就诊是独立的案例
```

## 📦 安装依赖

```bash
cd process_mining
pip install -r requirements.txt
```

## 🚀 快速开始（推荐）

### 方法 1: 一键运行

```bash
python quick_start.py your_data.xlsx
```

这个脚本会：
1. 自动检测数据文件
2. 诊断数据问题
3. 交互式映射列名
4. 转换为 XES 格式

### 方法 2: 分步执行

#### 步骤 1: 诊断数据

```bash
python diagnose_data.py your_data.xlsx
```

**重点关注以下输出：**

```
5. 挂号ID (Case ID) 分析:
   唯一挂号ID数量: 1000
   
   ✗ 警告: 每行都是不同的挂号ID！  ← 这说明Case ID错误！
      这意味着没有案例包含多个事件
      请检查是否使用了错误的列作为挂号ID
```

**如果看到上面的警告，说明您需要：**
1. 检查数据中是否有"挂号ID"、"就诊ID"、"案例ID"等列
2. 确认该列是否真的是每次就诊的唯一标识
3. 不要使用"用户ID"、"患者ID"作为 Case ID

#### 步骤 2: 清洗数据（如果需要）

```bash
python clean_data_example.py your_data.xlsx cleaned_data.xlsx
```

这会：
- 标准化列名
- 删除重复和缺失数据
- 统一活动名称
- 按时间排序

#### 步骤 3: 转换为 XES

修改 `convert_to_xes.py` 底部的文件名，然后运行：

```bash
python convert_to_xes.py
```

或者在 Python 中使用：

```python
from convert_to_xes import convert_to_xes
import pandas as pd

df = pd.read_excel('your_data.xlsx')
convert_to_xes(df, 'medical_process.xes')
```

## 📊 数据格式要求

### 必需的列

| 列名 | 说明 | 正确示例 | 错误示例 |
|------|------|----------|----------|
| 挂号ID | **每次就诊的唯一ID** | REG001, REG002 | 2400, 2401 (如果这是用户ID) |
| 活动名称 | 流程步骤 | 挂号, 检查, 报告审核 | event1, event2 |
| 开始时间 | 活动开始时间 | 2023-05-14 10:00:00 | 10:00 (缺少日期) |

### 如何判断 Case ID 是否正确？

在 Excel 中检查：

```
1. 筛选一个挂号ID
2. 查看该ID下的所有事件
3. 这些事件是否属于同一次就诊？

✓ 正确：
挂号ID: REG001
- 挂号 10:00
- 检查 10:30
- 报告审核 14:14
- 诊断 14:30
→ 这些是同一次就诊的完整流程

✗ 错误：
用户ID: 2400
- 挂号 5月14日
- 检查 5月14日
- 挂号 5月15日  ← 这是另一次就诊！
- 检查 5月15日
→ 混合了多次就诊
```

## 🔧 常见问题解决

### 问题 1: 数据中没有"挂号ID"列

**解决方案 A：** 如果有其他类似的列（如"就诊ID"、"案例ID"）

```python
# 在 convert_to_xes.py 中添加列名映射
df = df.rename(columns={
    '就诊ID': '挂号ID',
    '事件名称': '活动名称',
    '时间戳': '开始时间'
})
```

**解决方案 B：** 如果需要自己生成挂号ID

```python
# 根据用户ID和日期生成挂号ID
df['日期'] = pd.to_datetime(df['开始时间']).dt.date
df['挂号ID'] = df['用户ID'].astype(str) + '_' + df['日期'].astype(str)

# 或者根据时间间隔分组
# 假设同一用户相邻事件超过4小时就是新的就诊
df = df.sort_values(['用户ID', '开始时间'])
df['时间差'] = df.groupby('用户ID')['开始时间'].diff().dt.total_seconds() / 3600
df['新就诊'] = (df['时间差'] > 4) | df['时间差'].isna()
df['挂号ID'] = df.groupby('用户ID')['新就诊'].cumsum()
df['挂号ID'] = df['用户ID'].astype(str) + '_V' + df['挂号ID'].astype(str)
```

### 问题 2: 活动名称不统一

```python
# 标准化活动名称
activity_mapping = {
    '挂号': ['挂号', '门诊挂号', '预约挂号'],
    '检查': ['检查', '体检', '检验'],
    '报告审核': ['报告审核', '审核报告', '报告复核']
}

for standard, variants in activity_mapping.items():
    df.loc[df['活动名称'].isin(variants), '活动名称'] = standard
```

### 问题 3: 时间格式错误

```python
# 尝试多种时间格式
for fmt in ['%Y-%m-%d %H:%M:%S', '%Y/%m/%d %H:%M:%S', '%d/%m/%Y %H:%M']:
    try:
        df['开始时间'] = pd.to_datetime(df['开始时间'], format=fmt)
        break
    except:
        continue
```

### 问题 4: 转换后 ProM 仍然显示错误的流程

**检查清单：**

1. ✓ 确认 Case ID 正确
   ```python
   # 检查每个案例的事件数
   events_per_case = df.groupby('挂号ID').size()
   print(f"平均事件数: {events_per_case.mean()}")
   # 应该 > 2，理想情况 > 5
   ```

2. ✓ 确认数据已排序
   ```python
   df = df.sort_values(['挂号ID', '开始时间'])
   ```

3. ✓ 确认活动名称标准化
   ```python
   print(df['活动名称'].value_counts())
   # 不应该有太多相似的名称
   ```

4. ✓ 在 ProM 中使用正确的算法
   - 推荐：**Inductive Miner** (对噪声数据容忍度高)
   - 避免：Alpha Miner (对数据质量要求高)

## 📈 预期结果

### 正确的 Petri 网特征

```
[开始]
  ↓
挂号
  ↓
检查 ←→ 开单
  ↓
报告审核
  ↓
诊断
  ↓
开方
  ↓
配药
  ↓
发药
  ↓
收费
  ↓
[结束]
```

**特点：**
- ✓ 有清晰的主流程路径
- ✓ 活动之间有明确的先后顺序
- ✓ 可能有分支和循环（正常现象）
- ✓ 大部分案例遵循相似路径

### 错误的 Petri 网特征

```
[开始] → 挂号 ↘
      → 检查  ↘
      → 开方   → [结束]
      → 配药  ↗
      → 发药 ↗
```

**问题：**
- ✗ 所有活动都直接连到开始/结束
- ✗ 没有活动之间的顺序关系
- ✗ 像一个"星型"结构

**原因：** Case ID 错误，导致 ProM 认为每个事件都是独立的案例

## 🛠️ 调试技巧

### 技巧 1: 手动检查几个案例

```python
# 查看前3个案例的完整流程
for case_id in df['挂号ID'].unique()[:3]:
    print(f"\n案例 {case_id}:")
    case_data = df[df['挂号ID'] == case_id].sort_values('开始时间')
    for _, row in case_data.iterrows():
        print(f"  {row['开始时间']} - {row['活动名称']}")
```

**期望输出：**
```
案例 REG001:
  2023-05-14 10:00:00 - 挂号
  2023-05-14 10:30:00 - 检查
  2023-05-14 14:14:07 - 报告审核
  2023-05-14 14:30:00 - 诊断
  2023-05-14 15:00:00 - 开方
  2023-05-14 15:30:00 - 配药
  2023-05-14 16:00:00 - 发药
  2023-05-14 16:30:00 - 收费
```

### 技巧 2: 检查流程变体

```python
# 查看最常见的流程路径
variants = df.groupby('挂号ID')['活动名称'].apply(lambda x: ' → '.join(x))
print(variants.value_counts().head())
```

**期望输出：**
```
挂号 → 检查 → 报告审核 → 诊断 → 开方 → 配药 → 发药 → 收费    150
挂号 → 检查 → 诊断 → 开方 → 配药 → 发药 → 收费              80
挂号 → 检查 → 开方 → 配药 → 发药 → 收费                     50
```

### 技巧 3: 可视化时间线

```python
import matplotlib.pyplot as plt

# 选择一个案例可视化
case_id = df['挂号ID'].iloc[0]
case_data = df[df['挂号ID'] == case_id].sort_values('开始时间')

plt.figure(figsize=(12, 4))
plt.plot(case_data['开始时间'], range(len(case_data)), 'o-')
for i, row in case_data.iterrows():
    plt.text(row['开始时间'], case_data.index.get_loc(i), 
             row['活动名称'], fontsize=9)
plt.xlabel('时间')
plt.ylabel('事件序号')
plt.title(f'案例 {case_id} 的时间线')
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()
```

## 📚 完整工作流程

```bash
# 1. 准备数据
# 确保数据包含：挂号ID, 活动名称, 开始时间

# 2. 诊断数据
python diagnose_data.py your_data.xlsx

# 3. 如果发现问题，清洗数据
python clean_data_example.py your_data.xlsx cleaned_data.xlsx

# 4. 再次诊断清洗后的数据
python diagnose_data.py cleaned_data.xlsx

# 5. 转换为 XES
python convert_to_xes.py  # 需要修改脚本中的文件名

# 6. 在 ProM 中导入和分析
# - 打开 ProM
# - Import → medical_process.xes
# - Mine for a Petri Net using Inductive Miner
# - Visualize

# 7. 检查结果
# - 是否有清晰的主流程？
# - 活动顺序是否合理？
# - 如果不对，回到步骤2重新检查数据
```

## ⚠️ 重要提醒

1. **Case ID 是最关键的**
   - 必须是每次就诊的唯一标识
   - 不能是用户ID、患者ID
   - 每个 Case ID 应该包含多个事件（平均 > 3）

2. **数据质量很重要**
   - 活动名称要标准化
   - 时间要准确
   - 删除不完整的案例

3. **选择合适的挖掘算法**
   - 数据有噪声 → Inductive Miner
   - 数据很干净 → Alpha Miner
   - 流程很复杂 → Heuristic Miner

4. **迭代改进**
   - 第一次结果可能不完美
   - 根据 Petri 网反馈调整数据清洗
   - 多次尝试不同的参数

## 📞 需要帮助？

如果按照本指南操作后仍有问题：

1. 运行诊断脚本并保存输出
2. 检查前几个案例的数据
3. 截图 ProM 生成的 Petri 网
4. 提供数据样例（脱敏后）

祝您流程挖掘顺利！🎉




